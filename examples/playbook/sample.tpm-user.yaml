# TPM-backed certificate in CurrentUser store (Windows, no admin required)
#
# This playbook demonstrates requesting a certificate with the private key
# stored in the TPM 2.0 chip, installed in the CurrentUser certificate store.
#
# Use Case:
# - User-level applications that need TPM-protected certificates
# - Running vcert without administrator privileges
# - Per-user certificate management
#
# Note: LocalMachine store (sample.tpm.yaml) requires admin privileges,
# but CurrentUser store does NOT require admin privileges.
#
# Requirements:
# - Windows operating system with TPM 2.0
# - CAPI installation format (TPM keys cannot be exported to PEM, PKCS12, or JKS)
# - No administrator privileges required for CurrentUser store
#
# Key constraints:
# - RSA: Maximum 2048 bits on most TPM chips
# - ECDSA: P-256 and P-384 curves supported
# - ED25519: Not supported by TPM 2.0

config:
  connection:
    platform: vaas
    credentials:
      apiKey: '{{ Env "TLSPC_APIKEY" }}'

certificateTasks:
  - name: TPM User Certificate
    renewBefore: 31d
    request:
      # Use 'tpm' to require TPM (fails if TPM unavailable)
      # Use 'tpm_optional' to fall back to software if TPM unavailable
      csr: tpm
      keyType: RSA
      keySize: 2048  # Maximum guaranteed size for TPM 2.0
      subject:
        commonName: '{{ Env "USERNAME" }}-{{ Hostname | ToLower }}.example.com'
        country: US
        locality: Salt Lake City
        state: Utah
        organization: Example Corp
      sanDNS:
        - '{{ Env "USERNAME" }}-{{ Hostname | ToLower }}.example.com'
      zone: 'vcert\Default'

      # TPM-specific configuration
      tpmConfig:
        # Set to true to allow fallback to 2048-bit RSA if TPM doesn't
        # support larger key sizes. When false (default), requesting
        # unsupported key sizes will fail with an error.
        legacyKeySize: false

    installations:
      # CurrentUser store - does NOT require admin privileges
      # Note: TPM keys are inherently non-exportable
      - format: CAPI
        capiLocation: CurrentUser\My
        capiFriendlyName: TPM User Certificate
        afterInstallAction: 'Write-Host "Certificate installed in CurrentUser store with TPM-backed key"'
